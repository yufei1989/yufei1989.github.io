<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="1. æ¦‚è¿°æœ¬æ–‡ä¸»è¦è§£æ Namesrvã€Broker å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼ŒProducerã€Consumer æ€ä¹ˆä¸å®ƒä»¬é€šä¿¡ä¿è¯é«˜å¯ç”¨ã€‚ 2. Namesrv é«˜å¯ç”¨å¯åŠ¨å¤šä¸ª Namesrv å®ç°é«˜å¯ç”¨ã€‚ç›¸è¾ƒäº Zookeeperã€Consulã€Etcd ç­‰ï¼ŒNamesrv æ˜¯ä¸€ä¸ªè¶…è½»é‡çº§çš„æ³¨å†Œä¸­å¿ƒï¼Œæä¾›å‘½åæœåŠ¡ã€‚ 2.1 Broker æ³¨å†Œåˆ° Namesrv ğŸ“Œ å¤šä¸ª Namesrv ä¹‹é—´ï¼Œæ²¡æœ‰ä»»">
<meta property="og:type" content="article">
<meta property="og:title" content="RocketMqåœ¨é«˜å¹¶å‘æŠ—å‹åœºæ™¯çš„åº”ç”¨æ–¹æ¡ˆ">
<meta property="og:url" content="http://yoursite.com/2019/06/18/RocketMqåœ¨é«˜å¹¶å‘æŠ—å‹åœºæ™¯çš„åº”ç”¨æ–¹æ¡ˆ/index.html">
<meta property="og:site_name" content="Kedan&#39;s Bolg">
<meta property="og:description" content="1. æ¦‚è¿°æœ¬æ–‡ä¸»è¦è§£æ Namesrvã€Broker å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼ŒProducerã€Consumer æ€ä¹ˆä¸å®ƒä»¬é€šä¿¡ä¿è¯é«˜å¯ç”¨ã€‚ 2. Namesrv é«˜å¯ç”¨å¯åŠ¨å¤šä¸ª Namesrv å®ç°é«˜å¯ç”¨ã€‚ç›¸è¾ƒäº Zookeeperã€Consulã€Etcd ç­‰ï¼ŒNamesrv æ˜¯ä¸€ä¸ªè¶…è½»é‡çº§çš„æ³¨å†Œä¸­å¿ƒï¼Œæä¾›å‘½åæœåŠ¡ã€‚ 2.1 Broker æ³¨å†Œåˆ° Namesrv ğŸ“Œ å¤šä¸ª Namesrv ä¹‹é—´ï¼Œæ²¡æœ‰ä»»">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://static.iocoder.cn/images/RocketMQ/2017_05_14/04.png">
<meta property="og:image" content="http://static.iocoder.cn/images/RocketMQ/2017_05_14/02.png">
<meta property="og:image" content="http://static.iocoder.cn/images/RocketMQ/2017_05_14/01.png">
<meta property="og:image" content="http://static.iocoder.cn/images/RocketMQ/2017_05_14/05.png">
<meta property="og:image" content="http://static.iocoder.cn/images/RocketMQ/2017_05_14/03.jpeg">
<meta property="og:updated_time" content="2019-06-20T01:20:06.313Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RocketMqåœ¨é«˜å¹¶å‘æŠ—å‹åœºæ™¯çš„åº”ç”¨æ–¹æ¡ˆ">
<meta name="twitter:description" content="1. æ¦‚è¿°æœ¬æ–‡ä¸»è¦è§£æ Namesrvã€Broker å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼ŒProducerã€Consumer æ€ä¹ˆä¸å®ƒä»¬é€šä¿¡ä¿è¯é«˜å¯ç”¨ã€‚ 2. Namesrv é«˜å¯ç”¨å¯åŠ¨å¤šä¸ª Namesrv å®ç°é«˜å¯ç”¨ã€‚ç›¸è¾ƒäº Zookeeperã€Consulã€Etcd ç­‰ï¼ŒNamesrv æ˜¯ä¸€ä¸ªè¶…è½»é‡çº§çš„æ³¨å†Œä¸­å¿ƒï¼Œæä¾›å‘½åæœåŠ¡ã€‚ 2.1 Broker æ³¨å†Œåˆ° Namesrv ğŸ“Œ å¤šä¸ª Namesrv ä¹‹é—´ï¼Œæ²¡æœ‰ä»»">
<meta name="twitter:image" content="http://static.iocoder.cn/images/RocketMQ/2017_05_14/04.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/06/18/RocketMqåœ¨é«˜å¹¶å‘æŠ—å‹åœºæ™¯çš„åº”ç”¨æ–¹æ¡ˆ/">





  <title>RocketMqåœ¨é«˜å¹¶å‘æŠ—å‹åœºæ™¯çš„åº”ç”¨æ–¹æ¡ˆ | Kedan's Bolg</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Kedan's Bolg</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">çˆ±éª‘å°æ¯›é©´çš„ç å†œ</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            æ ‡ç­¾
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            åˆ†ç±»
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            å½’æ¡£
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/18/RocketMqåœ¨é«˜å¹¶å‘æŠ—å‹åœºæ™¯çš„åº”ç”¨æ–¹æ¡ˆ/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ke Dan">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Kedan's Bolg">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">RocketMqåœ¨é«˜å¹¶å‘æŠ—å‹åœºæ™¯çš„åº”ç”¨æ–¹æ¡ˆ</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2019-06-18T17:43:20+08:00">
                2019-06-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ä¸»è¦è§£æ <code>Namesrv</code>ã€<code>Broker</code> å¦‚ä½•å®ç°é«˜å¯ç”¨ï¼Œ<code>Producer</code>ã€<code>Consumer</code> æ€ä¹ˆä¸å®ƒä»¬é€šä¿¡ä¿è¯é«˜å¯ç”¨ã€‚</p>
<h1 id="2-Namesrv-é«˜å¯ç”¨"><a href="#2-Namesrv-é«˜å¯ç”¨" class="headerlink" title="2. Namesrv é«˜å¯ç”¨"></a>2. Namesrv é«˜å¯ç”¨</h1><p><strong>å¯åŠ¨å¤šä¸ª Namesrv å®ç°é«˜å¯ç”¨ã€‚</strong><br>ç›¸è¾ƒäº <code>Zookeeper</code>ã€<code>Consul</code>ã€<code>Etcd</code> ç­‰ï¼Œ<code>Namesrv</code> æ˜¯ä¸€ä¸ª<strong>è¶…è½»é‡çº§</strong>çš„æ³¨å†Œä¸­å¿ƒï¼Œæä¾›<strong>å‘½åæœåŠ¡</strong>ã€‚</p>
<h2 id="2-1-Broker-æ³¨å†Œåˆ°-Namesrv"><a href="#2-1-Broker-æ³¨å†Œåˆ°-Namesrv" class="headerlink" title="2.1 Broker æ³¨å†Œåˆ° Namesrv"></a>2.1 Broker æ³¨å†Œåˆ° Namesrv</h2><ul>
<li>ğŸ“Œ <strong>å¤šä¸ª Namesrv ä¹‹é—´ï¼Œæ²¡æœ‰ä»»ä½•å…³ç³»ï¼ˆä¸å­˜åœ¨ç±»ä¼¼ Zookeeper çš„ Leader/Follower ç­‰è§’è‰²ï¼‰ï¼Œä¸è¿›è¡Œé€šä¿¡ä¸æ•°æ®åŒæ­¥ã€‚é€šè¿‡ Broker å¾ªç¯æ³¨å†Œå¤šä¸ª Namesrvã€‚</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> 1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€BrokerOuterAPI.javaã€‘</span><br><span class="line"> 2: public RegisterBrokerResult registerBrokerAll(</span><br><span class="line"> 3:     final String clusterName,</span><br><span class="line"> 4:     final String brokerAddr,</span><br><span class="line"> 5:     final String brokerName,</span><br><span class="line"> 6:     final long brokerId,</span><br><span class="line"> 7:     final String haServerAddr,</span><br><span class="line"> 8:     final TopicConfigSerializeWrapper topicConfigWrapper,</span><br><span class="line"> 9:     final List&lt;String&gt; filterServerList,</span><br><span class="line">10:     final boolean oneway,</span><br><span class="line">11:     final int timeoutMills) &#123;</span><br><span class="line">12:     RegisterBrokerResult registerBrokerResult = null;</span><br><span class="line">13: </span><br><span class="line">14:     List&lt;String&gt; nameServerAddressList = this.remotingClient.getNameServerAddressList();</span><br><span class="line">15:     if (nameServerAddressList != null) &#123;</span><br><span class="line">16:         for (String namesrvAddr : nameServerAddressList) &#123; // å¾ªç¯å¤šä¸ª Namesrv</span><br><span class="line">17:             try &#123;</span><br><span class="line">18:                 RegisterBrokerResult result = this.registerBroker(namesrvAddr, clusterName, brokerAddr, brokerName, brokerId,</span><br><span class="line">19:                     haServerAddr, topicConfigWrapper, filterServerList, oneway, timeoutMills);</span><br><span class="line">20:                 if (result != null) &#123;</span><br><span class="line">21:                     registerBrokerResult = result;</span><br><span class="line">22:                 &#125;</span><br><span class="line">23: </span><br><span class="line">24:                 log.info(&quot;register broker to name server &#123;&#125; OK&quot;, namesrvAddr);</span><br><span class="line">25:             &#125; catch (Exception e) &#123;</span><br><span class="line">26:                 log.warn(&quot;registerBroker Exception, &#123;&#125;&quot;, namesrvAddr, e);</span><br><span class="line">27:             &#125;</span><br><span class="line">28:         &#125;</span><br><span class="line">29:     &#125;</span><br><span class="line">30: </span><br><span class="line">31:     return registerBrokerResult;</span><br><span class="line">32: &#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-2-Producerã€Consumer-è®¿é—®-Namesrv"><a href="#2-2-Producerã€Consumer-è®¿é—®-Namesrv" class="headerlink" title="2.2 Producerã€Consumer è®¿é—® Namesrv"></a>2.2 Producerã€Consumer è®¿é—® Namesrv</h2><ul>
<li>ğŸ“Œ <strong>Producerã€Consumer ä» Namesrvåˆ—è¡¨é€‰æ‹©ä¸€ä¸ªå¯è¿æ¥çš„è¿›è¡Œé€šä¿¡ã€‚</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"> 1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€NettyRemotingClient.javaã€‘</span><br><span class="line"> 2: private Channel getAndCreateNameserverChannel() throws InterruptedException &#123;</span><br><span class="line"> 3:     // è¿”å›å·²é€‰æ‹©ã€å¯è¿æ¥Namesrv</span><br><span class="line"> 4:     String addr = this.namesrvAddrChoosed.get();</span><br><span class="line"> 5:     if (addr != null) &#123;</span><br><span class="line"> 6:         ChannelWrapper cw = this.channelTables.get(addr);</span><br><span class="line"> 7:         if (cw != null &amp;&amp; cw.isOK()) &#123;</span><br><span class="line"> 8:             return cw.getChannel();</span><br><span class="line"> 9:         &#125;</span><br><span class="line">10:     &#125;</span><br><span class="line">11:     //</span><br><span class="line">12:     final List&lt;String&gt; addrList = this.namesrvAddrList.get();</span><br><span class="line">13:     if (this.lockNamesrvChannel.tryLock(LOCK_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">14:         try &#123;</span><br><span class="line">15:             // è¿”å›å·²é€‰æ‹©ã€å¯è¿æ¥çš„Namesrv</span><br><span class="line">16:             addr = this.namesrvAddrChoosed.get();</span><br><span class="line">17:             if (addr != null) &#123;</span><br><span class="line">18:                 ChannelWrapper cw = this.channelTables.get(addr);</span><br><span class="line">19:                 if (cw != null &amp;&amp; cw.isOK()) &#123;</span><br><span class="line">20:                     return cw.getChannel();</span><br><span class="line">21:                 &#125;</span><br><span class="line">22:             &#125;</span><br><span class="line">23:             // ä»ã€Namesrvåˆ—è¡¨ã€‘ä¸­é€‰æ‹©ä¸€ä¸ªè¿æ¥çš„è¿”å›</span><br><span class="line">24:             if (addrList != null &amp;&amp; !addrList.isEmpty()) &#123;</span><br><span class="line">25:                 for (int i = 0; i &lt; addrList.size(); i++) &#123;</span><br><span class="line">26:                     int index = this.namesrvIndex.incrementAndGet();</span><br><span class="line">27:                     index = Math.abs(index);</span><br><span class="line">28:                     index = index % addrList.size();</span><br><span class="line">29:                     String newAddr = addrList.get(index);</span><br><span class="line">30: </span><br><span class="line">31:                     this.namesrvAddrChoosed.set(newAddr);</span><br><span class="line">32:                     Channel channelNew = this.createChannel(newAddr);</span><br><span class="line">33:                     if (channelNew != null)</span><br><span class="line">34:                         return channelNew;</span><br><span class="line">35:                 &#125;</span><br><span class="line">36:             &#125;</span><br><span class="line">37:         &#125; catch (Exception e) &#123;</span><br><span class="line">38:             log.error(&quot;getAndCreateNameserverChannel: create name server channel exception&quot;, e);</span><br><span class="line">39:         &#125; finally &#123;</span><br><span class="line">40:             this.lockNamesrvChannel.unlock();</span><br><span class="line">41:         &#125;</span><br><span class="line">42:     &#125; else &#123;</span><br><span class="line">43:         log.warn(&quot;getAndCreateNameserverChannel: try to lock name server, but timeout, &#123;&#125;ms&quot;, LOCK_TIMEOUT_MILLIS);</span><br><span class="line">44:     &#125;</span><br><span class="line">45: </span><br><span class="line">46:     return null;</span><br><span class="line">47: &#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-Broker-é«˜å¯ç”¨"><a href="#3-Broker-é«˜å¯ç”¨" class="headerlink" title="3. Broker é«˜å¯ç”¨"></a>3. Broker é«˜å¯ç”¨</h1><p><strong>å¯åŠ¨å¤šä¸ª Brokeråˆ†ç»„ å½¢æˆ é›†ç¾¤ å®ç°é«˜å¯ç”¨ã€‚</strong><br><strong>Brokeråˆ†ç»„ = MasterèŠ‚ç‚¹x1 + SlaveèŠ‚ç‚¹xNã€‚</strong><br>ç±»ä¼¼ <code>MySQL</code>ï¼Œ<code>MasterèŠ‚ç‚¹</code> æä¾›<strong>è¯»å†™</strong>æœåŠ¡ï¼Œ<code>SlaveèŠ‚ç‚¹</code> åªæä¾›<strong>è¯»</strong>æœåŠ¡ã€‚</p>
<h2 id="3-2-Broker-ä¸»ä»"><a href="#3-2-Broker-ä¸»ä»" class="headerlink" title="3.2 Broker ä¸»ä»"></a>3.2 Broker ä¸»ä»</h2><ul>
<li><strong>æ¯ä¸ªåˆ†ç»„ï¼ŒMasterèŠ‚ç‚¹ ä¸æ–­å‘é€æ–°çš„ CommitLog ç»™ SlaveèŠ‚ç‚¹ã€‚ SlaveèŠ‚ç‚¹ ä¸æ–­ä¸ŠæŠ¥æœ¬åœ°çš„ CommitLogå·²ç»åŒæ­¥åˆ°çš„ä½ç½®ç»™ MasterèŠ‚ç‚¹ã€‚</strong></li>
<li><strong>Brokeråˆ†ç»„ ä¸ Brokeråˆ†ç»„ ä¹‹é—´æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œä¸è¿›è¡Œé€šä¿¡ä¸æ•°æ®åŒæ­¥ã€‚</strong></li>
<li><strong>æ¶ˆè´¹è¿›åº¦ ç›®å‰ä¸æ”¯æŒ Master/Slave åŒæ­¥ã€‚</strong><ul>
<li><code>org.apache.rocketmq.broker.slave.SlaveSynchronize</code> ç±»ï¼Œ<code>Slave</code> èŠ‚ç‚¹ä¼šä» <code>Master</code> èŠ‚ç‚¹æ‹‰å–æ¶ˆè´¹è¿›åº¦ã€Topic é…ç½®ç­‰ç­‰ã€‚</li>
</ul>
</li>
</ul>
<p>é›†ç¾¤å†…ï¼Œ<code>Master</code>èŠ‚ç‚¹ æœ‰<strong>ä¸¤ç§</strong>ç±»å‹ï¼š<code>Master_SYNC</code>ã€<code>Master_ASYNC</code>ï¼šå‰è€…åœ¨ <code>Producer</code> å‘é€æ¶ˆæ¯æ—¶ï¼Œç­‰å¾… <code>Slave</code>èŠ‚ç‚¹ å­˜å‚¨å®Œæ¯•åå†è¿”å›å‘é€ç»“æœï¼Œè€Œåè€…ä¸éœ€è¦ç­‰å¾…ã€‚</p>
<h3 id="3-1-1-é…ç½®"><a href="#3-1-1-é…ç½®" class="headerlink" title="3.1.1 é…ç½®"></a>3.1.1 é…ç½®</h3><p>ç›®å‰å®˜æ–¹æä¾›ä¸‰å¥—é…ç½®ï¼š</p>
<ul>
<li><strong>2m-2s-async</strong></li>
</ul>
<table>
<thead>
<tr>
<th>brokerClusterName</th>
<th>brokerName</th>
<th>brokerRole</th>
<th>brokerId</th>
</tr>
</thead>
<tbody><tr>
<td>DefaultCluster</td>
<td>broker-a</td>
<td>ASYNC_MASTER</td>
<td>0</td>
</tr>
<tr>
<td>DefaultCluster</td>
<td>broker-a</td>
<td>SLAVE</td>
<td>1</td>
</tr>
<tr>
<td>DefaultCluster</td>
<td>broker-b</td>
<td>ASYNC_MASTER</td>
<td>0</td>
</tr>
<tr>
<td>DefaultCluster</td>
<td>broker-b</td>
<td>SLAVE</td>
<td>1</td>
</tr>
</tbody></table>
<ul>
<li><strong>2m-2s-sync</strong></li>
</ul>
<table>
<thead>
<tr>
<th>brokerClusterName</th>
<th>brokerName</th>
<th>brokerRole</th>
<th>brokerId</th>
</tr>
</thead>
<tbody><tr>
<td>DefaultCluster</td>
<td>broker-a</td>
<td>SYNC_MASTER</td>
<td>0</td>
</tr>
<tr>
<td>DefaultCluster</td>
<td>broker-a</td>
<td>SLAVE</td>
<td>1</td>
</tr>
<tr>
<td>DefaultCluster</td>
<td>broker-b</td>
<td>SYNC_MASTER</td>
<td>0</td>
</tr>
<tr>
<td>DefaultCluster</td>
<td>broker-b</td>
<td>SLAVE</td>
<td>1</td>
</tr>
</tbody></table>
<ul>
<li><strong>2m-noslave</strong></li>
</ul>
<table>
<thead>
<tr>
<th>brokerClusterName</th>
<th>brokerName</th>
<th>brokerRole</th>
<th>brokerId</th>
</tr>
</thead>
<tbody><tr>
<td>DefaultCluster</td>
<td>broker-a</td>
<td>ASYNC_MASTER</td>
<td>0</td>
</tr>
<tr>
<td>DefaultCluster</td>
<td>broker-b</td>
<td>ASYNC_MASTER</td>
<td>0</td>
</tr>
</tbody></table>
<h3 id="3-1-2-ç»„ä»¶"><a href="#3-1-2-ç»„ä»¶" class="headerlink" title="3.1.2 ç»„ä»¶"></a>3.1.2 ç»„ä»¶</h3><p>å†çœ‹å…·ä½“å®ç°ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ <code>Master</code>/<code>Slave</code>èŠ‚ç‚¹ åŒ…å«çš„ç»„ä»¶ï¼š<br><img src="http://static.iocoder.cn/images/RocketMQ/2017_05_14/04.png" alt="HAç»„ä»¶å›¾.png"></p>
<ul>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Master</span><br></pre></td></tr></table></figure>

<p>èŠ‚ç‚¹</p>
<ul>
<li><p><code>AcceptSocketService</code> ï¼šæ¥æ”¶ <code>Slave</code>èŠ‚ç‚¹ è¿æ¥ã€‚</p>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HAConnection</span><br></pre></td></tr></table></figure>

<ul>
<li><code>ReadSocketService</code> ï¼š<strong>è¯»</strong>æ¥è‡ª <code>Slave</code>èŠ‚ç‚¹ çš„æ•°æ®ã€‚</li>
<li><code>WriteSocketService</code> ï¼š<strong>å†™</strong>åˆ°å¾€ <code>Slave</code>èŠ‚ç‚¹ çš„æ•°æ®ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Slave</span><br></pre></td></tr></table></figure>

<p>èŠ‚ç‚¹</p>
<ul>
<li><code>HAClient</code> ï¼šå¯¹ <code>Master</code>èŠ‚ç‚¹ è¿æ¥ã€è¯»å†™æ•°æ®ã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-1-3-é€šä¿¡åè®®"><a href="#3-1-3-é€šä¿¡åè®®" class="headerlink" title="3.1.3 é€šä¿¡åè®®"></a>3.1.3 é€šä¿¡åè®®</h3><p><code>Master</code>èŠ‚ç‚¹ ä¸ <code>Slave</code>èŠ‚ç‚¹ <strong>é€šä¿¡åè®®</strong>å¾ˆç®€å•ï¼Œåªæœ‰å¦‚ä¸‹ä¸¤æ¡ã€‚</p>
<table>
<thead>
<tr>
<th>å¯¹è±¡</th>
<th>ç”¨é€”</th>
<th>ç¬¬å‡ ä½</th>
<th>å­—æ®µ</th>
<th>æ•°æ®ç±»å‹</th>
<th>å­—èŠ‚æ•°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>Slave=&gt;Master</td>
<td>ä¸ŠæŠ¥CommitLog<strong>å·²ç»</strong>åŒæ­¥åˆ°çš„<strong>ç‰©ç†</strong>ä½ç½®</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>0</td>
<td>maxPhyOffset</td>
<td>Long</td>
<td>8</td>
<td>CommitLogæœ€å¤§ç‰©ç†ä½ç½®</td>
</tr>
<tr>
<td>Master=&gt;Slave</td>
<td>ä¼ è¾“æ–°çš„ <code>CommitLog</code> æ•°æ®</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>0</td>
<td>fromPhyOffset</td>
<td>Long</td>
<td>8</td>
<td>CommitLogå¼€å§‹ç‰©ç†ä½ç½®</td>
</tr>
<tr>
<td></td>
<td></td>
<td>1</td>
<td>size</td>
<td>Int</td>
<td>4</td>
<td>ä¼ è¾“CommitLogæ•°æ®é•¿åº¦</td>
</tr>
<tr>
<td></td>
<td></td>
<td>2</td>
<td>body</td>
<td>Bytes</td>
<td>size</td>
<td>ä¼ è¾“CommitLogæ•°æ®</td>
</tr>
</tbody></table>
<h3 id="3-1-4-Slave"><a href="#3-1-4-Slave" class="headerlink" title="3.1.4 Slave"></a>3.1.4 Slave</h3><p><img src="http://static.iocoder.cn/images/RocketMQ/2017_05_14/02.png" alt="HAClienté¡ºåºå›¾"></p>
<hr>
<ul>
<li><strong>Slave ä¸»å¾ªç¯ï¼Œå®ç°äº†</strong>ä¸æ–­ä¸æ–­ä¸æ–­<strong>ä» Master ä¼ è¾“ CommitLog æ•°æ®ï¼Œä¸Šä¼  Master è‡ªå·±æœ¬åœ°çš„ CommitLogå·²ç»åŒæ­¥ç‰©ç†ä½ç½®ã€‚</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"> 1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€HAClient.javaã€‘</span><br><span class="line"> 2: public void run() &#123;</span><br><span class="line"> 3:     log.info(this.getServiceName() + &quot; service started&quot;);</span><br><span class="line"> 4: </span><br><span class="line"> 5:     while (!this.isStopped()) &#123;</span><br><span class="line"> 6:         try &#123;</span><br><span class="line"> 7:             if (this.connectMaster()) &#123;</span><br><span class="line"> 8:                 // è‹¥åˆ°æ»¡è¶³ä¸ŠæŠ¥é—´éš”ï¼Œä¸ŠæŠ¥åˆ°Masterè¿›åº¦</span><br><span class="line"> 9:                 if (this.isTimeToReportOffset()) &#123;</span><br><span class="line">10:                     boolean result = this.reportSlaveMaxOffset(this.currentReportedOffset);</span><br><span class="line">11:                     if (!result) &#123;</span><br><span class="line">12:                         this.closeMaster();</span><br><span class="line">13:                     &#125;</span><br><span class="line">14:                 &#125;</span><br><span class="line">15: </span><br><span class="line">16:                 this.selector.select(1000);</span><br><span class="line">17: </span><br><span class="line">18:                 // å¤„ç†è¯»å–äº‹ä»¶</span><br><span class="line">19:                 boolean ok = this.processReadEvent();</span><br><span class="line">20:                 if (!ok) &#123;</span><br><span class="line">21:                     this.closeMaster();</span><br><span class="line">22:                 &#125;</span><br><span class="line">23: </span><br><span class="line">24:                 // è‹¥è¿›åº¦æœ‰å˜åŒ–ï¼Œä¸ŠæŠ¥åˆ°Masterè¿›åº¦</span><br><span class="line">25:                 if (!reportSlaveMaxOffsetPlus()) &#123;</span><br><span class="line">26:                     continue;</span><br><span class="line">27:                 &#125;</span><br><span class="line">28: </span><br><span class="line">29:                 // Masterè¿‡ä¹…æœªè¿”å›æ•°æ®ï¼Œå…³é—­è¿æ¥</span><br><span class="line">30:                 long interval = HAService.this.getDefaultMessageStore().getSystemClock().now() - this.lastWriteTimestamp;</span><br><span class="line">31:                 if (interval &gt; HAService.this.getDefaultMessageStore().getMessageStoreConfig()</span><br><span class="line">32:                     .getHaHousekeepingInterval()) &#123;</span><br><span class="line">33:                     log.warn(&quot;HAClient, housekeeping, found this connection[&quot; + this.masterAddress</span><br><span class="line">34:                         + &quot;] expired, &quot; + interval);</span><br><span class="line">35:                     this.closeMaster();</span><br><span class="line">36:                     log.warn(&quot;HAClient, master not response some time, so close connection&quot;);</span><br><span class="line">37:                 &#125;</span><br><span class="line">38:             &#125; else &#123;</span><br><span class="line">39:                 this.waitForRunning(1000 * 5);</span><br><span class="line">40:             &#125;</span><br><span class="line">41:         &#125; catch (Exception e) &#123;</span><br><span class="line">42:             log.warn(this.getServiceName() + &quot; service has exception. &quot;, e);</span><br><span class="line">43:             this.waitForRunning(1000 * 5);</span><br><span class="line">44:         &#125;</span><br><span class="line">45:     &#125;</span><br><span class="line">46: </span><br><span class="line">47:     log.info(this.getServiceName() + &quot; service end&quot;);</span><br><span class="line">48: &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¬¬ 8 è‡³ 14 è¡Œ ï¼š<strong>å›ºå®šé—´éš”ï¼ˆé»˜è®¤5sï¼‰</strong>å‘ <code>Master</code> ä¸ŠæŠ¥ <code>Slave</code> æœ¬åœ° <code>CommitLog</code> å·²ç»åŒæ­¥åˆ°çš„ç‰©ç†ä½ç½®ã€‚è¯¥æ“ä½œè¿˜æœ‰<strong>å¿ƒè·³</strong>çš„ä½œç”¨ã€‚</li>
<li>ç¬¬ 16 è‡³ 22 è¡Œ ï¼šå¤„ç† <code>Master</code> ä¼ è¾“ <code>Slave</code> çš„ <code>CommitLog</code> æ•°æ®ã€‚</li>
</ul>
<hr>
<ul>
<li><strong>æˆ‘ä»¬æ¥çœ‹çœ‹ #dispatchReadRequest(â€¦) ä¸ #reportSlaveMaxOffset(â€¦) æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"> 1: // ã€HAClient.javaã€‘</span><br><span class="line"> 2: /**</span><br><span class="line"> 3:  * è¯»å–Masterä¼ è¾“çš„CommitLogæ•°æ®ï¼Œå¹¶è¿”å›æ˜¯å¼‚å¸¸</span><br><span class="line"> 4:  * å¦‚æœè¯»å–åˆ°æ•°æ®ï¼Œå†™å…¥CommitLog</span><br><span class="line"> 5:  * å¼‚å¸¸åŸå› ï¼š</span><br><span class="line"> 6:  *   1. Masterä¼ è¾“æ¥çš„æ•°æ®offset ä¸ç­‰äº Slaveçš„CommitLogæ•°æ®æœ€å¤§offset</span><br><span class="line"> 7:  *   2. ä¸ŠæŠ¥åˆ°Masterè¿›åº¦å¤±è´¥</span><br><span class="line"> 8:  *</span><br><span class="line"> 9:  * @return æ˜¯å¦å¼‚å¸¸</span><br><span class="line">10:  */</span><br><span class="line">11: private boolean dispatchReadRequest() &#123;</span><br><span class="line">12:     final int msgHeaderSize = 8 + 4; // phyoffset + size</span><br><span class="line">13:     int readSocketPos = this.byteBufferRead.position();</span><br><span class="line">14: </span><br><span class="line">15:     while (true) &#123;</span><br><span class="line">16:         // è¯»å–åˆ°è¯·æ±‚</span><br><span class="line">17:         int diff = this.byteBufferRead.position() - this.dispatchPostion;</span><br><span class="line">18:         if (diff &gt;= msgHeaderSize) &#123;</span><br><span class="line">19:             // è¯»å–masterPhyOffsetã€bodySizeã€‚ä½¿ç”¨dispatchPostionçš„åŸå› æ˜¯ï¼šå¤„ç†æ•°æ®â€œç²˜åŒ…â€å¯¼è‡´æ•°æ®è¯»å–ä¸å®Œæ•´ã€‚</span><br><span class="line">20:             long masterPhyOffset = this.byteBufferRead.getLong(this.dispatchPostion);</span><br><span class="line">21:             int bodySize = this.byteBufferRead.getInt(this.dispatchPostion + 8);</span><br><span class="line">22:             // æ ¡éªŒ Masterä¼ è¾“æ¥çš„æ•°æ®offset æ˜¯å¦å’Œ Slaveçš„CommitLogæ•°æ®æœ€å¤§offset æ˜¯å¦ç›¸åŒã€‚</span><br><span class="line">23:             long slavePhyOffset = HAService.this.defaultMessageStore.getMaxPhyOffset();</span><br><span class="line">24:             if (slavePhyOffset != 0) &#123;</span><br><span class="line">25:                 if (slavePhyOffset != masterPhyOffset) &#123;</span><br><span class="line">26:                     log.error(&quot;master pushed offset not equal the max phy offset in slave, SLAVE: &quot;</span><br><span class="line">27:                         + slavePhyOffset + &quot; MASTER: &quot; + masterPhyOffset);</span><br><span class="line">28:                     return false;</span><br><span class="line">29:                 &#125;</span><br><span class="line">30:             &#125;</span><br><span class="line">31:             // è¯»å–åˆ°æ¶ˆæ¯</span><br><span class="line">32:             if (diff &gt;= (msgHeaderSize + bodySize)) &#123;</span><br><span class="line">33:                 // å†™å…¥CommitLog</span><br><span class="line">34:                 byte[] bodyData = new byte[bodySize];</span><br><span class="line">35:                 this.byteBufferRead.position(this.dispatchPostion + msgHeaderSize);</span><br><span class="line">36:                 this.byteBufferRead.get(bodyData);</span><br><span class="line">37:                 HAService.this.defaultMessageStore.appendToCommitLog(masterPhyOffset, bodyData);</span><br><span class="line">38:                 // è®¾ç½®å¤„ç†åˆ°çš„ä½ç½®</span><br><span class="line">39:                 this.byteBufferRead.position(readSocketPos);</span><br><span class="line">40:                 this.dispatchPostion += msgHeaderSize + bodySize;</span><br><span class="line">41:                 // ä¸ŠæŠ¥åˆ°Masterè¿›åº¦</span><br><span class="line">42:                 if (!reportSlaveMaxOffsetPlus()) &#123;</span><br><span class="line">43:                     return false;</span><br><span class="line">44:                 &#125;</span><br><span class="line">45:                 // ç»§ç»­å¾ªç¯</span><br><span class="line">46:                 continue;</span><br><span class="line">47:             &#125;</span><br><span class="line">48:         &#125;</span><br><span class="line">49: </span><br><span class="line">50:         // ç©ºé—´å†™æ»¡ï¼Œé‡æ–°åˆ†é…ç©ºé—´</span><br><span class="line">51:         if (!this.byteBufferRead.hasRemaining()) &#123;</span><br><span class="line">52:             this.reallocateByteBuffer();</span><br><span class="line">53:         &#125;</span><br><span class="line">54: </span><br><span class="line">55:         break;</span><br><span class="line">56:     &#125;</span><br><span class="line">57: </span><br><span class="line">58:     return true;</span><br><span class="line">59: &#125;</span><br><span class="line">60: </span><br><span class="line">61: /**</span><br><span class="line">62:  * ä¸ŠæŠ¥è¿›åº¦</span><br><span class="line">63:  *</span><br><span class="line">64:  * @param maxOffset è¿›åº¦</span><br><span class="line">65:  * @return æ˜¯å¦ä¸ŠæŠ¥æˆåŠŸ</span><br><span class="line">66:  */</span><br><span class="line">67: private boolean reportSlaveMaxOffset(final long maxOffset) &#123;</span><br><span class="line">68:     this.reportOffset.position(0);</span><br><span class="line">69:     this.reportOffset.limit(8);</span><br><span class="line">70:     this.reportOffset.putLong(maxOffset);</span><br><span class="line">71:     this.reportOffset.position(0);</span><br><span class="line">72:     this.reportOffset.limit(8);</span><br><span class="line">73: </span><br><span class="line">74:     for (int i = 0; i &lt; 3 &amp;&amp; this.reportOffset.hasRemaining(); i++) &#123;</span><br><span class="line">75:         try &#123;</span><br><span class="line">76:             this.socketChannel.write(this.reportOffset);</span><br><span class="line">77:         &#125; catch (IOException e) &#123;</span><br><span class="line">78:             log.error(this.getServiceName()</span><br><span class="line">79:                 + &quot;reportSlaveMaxOffset this.socketChannel.write exception&quot;, e);</span><br><span class="line">80:             return false;</span><br><span class="line">81:         &#125;</span><br><span class="line">82:     &#125;</span><br><span class="line">83: </span><br><span class="line">84:     return !this.reportOffset.hasRemaining();</span><br><span class="line">85: &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-5-Master"><a href="#3-1-5-Master" class="headerlink" title="3.1.5 Master"></a>3.1.5 Master</h3><ul>
<li><strong>ReadSocketService é€»è¾‘åŒ HAClient#processReadEvent(â€¦) åŸºæœ¬ç›¸åŒï¼Œæˆ‘ä»¬ç›´æ¥çœ‹ä»£ç ã€‚</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"> 1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ReadSocketService.javaã€‘</span><br><span class="line"> 2: private boolean processReadEvent() &#123;</span><br><span class="line"> 3:     int readSizeZeroTimes = 0;</span><br><span class="line"> 4: </span><br><span class="line"> 5:     // æ¸…ç©ºbyteBufferRead</span><br><span class="line"> 6:     if (!this.byteBufferRead.hasRemaining()) &#123;</span><br><span class="line"> 7:         this.byteBufferRead.flip();</span><br><span class="line"> 8:         this.processPostion = 0;</span><br><span class="line"> 9:     &#125;</span><br><span class="line">10: </span><br><span class="line">11:     while (this.byteBufferRead.hasRemaining()) &#123;</span><br><span class="line">12:         try &#123;</span><br><span class="line">13:             int readSize = this.socketChannel.read(this.byteBufferRead);</span><br><span class="line">14:             if (readSize &gt; 0) &#123;</span><br><span class="line">15:                 readSizeZeroTimes = 0;</span><br><span class="line">16: </span><br><span class="line">17:                 // è®¾ç½®æœ€åè¯»å–æ—¶é—´</span><br><span class="line">18:                 this.lastReadTimestamp = HAConnection.this.haService.getDefaultMessageStore().getSystemClock().now();</span><br><span class="line">19: </span><br><span class="line">20:                 if ((this.byteBufferRead.position() - this.processPostion) &gt;= 8) &#123;</span><br><span class="line">21:                     // è¯»å–Slave è¯·æ±‚æ¥çš„CommitLogçš„æœ€å¤§ä½ç½®</span><br><span class="line">22:                     int pos = this.byteBufferRead.position() - (this.byteBufferRead.position() % 8);</span><br><span class="line">23:                     long readOffset = this.byteBufferRead.getLong(pos - 8);</span><br><span class="line">24:                     this.processPostion = pos;</span><br><span class="line">25: </span><br><span class="line">26:                     // è®¾ç½®Slave CommitLogçš„æœ€å¤§ä½ç½®</span><br><span class="line">27:                     HAConnection.this.slaveAckOffset = readOffset;</span><br><span class="line">28: </span><br><span class="line">29:                     // è®¾ç½®Slave ç¬¬ä¸€æ¬¡è¯·æ±‚çš„ä½ç½®</span><br><span class="line">30:                     if (HAConnection.this.slaveRequestOffset &lt; 0) &#123;</span><br><span class="line">31:                         HAConnection.this.slaveRequestOffset = readOffset;</span><br><span class="line">32:                         log.info(&quot;slave[&quot; + HAConnection.this.clientAddr + &quot;] request offset &quot; + readOffset);</span><br><span class="line">33:                     &#125;</span><br><span class="line">34: </span><br><span class="line">35:                     // é€šçŸ¥ç›®å‰Slaveè¿›åº¦ã€‚ä¸»è¦ç”¨äºMasterèŠ‚ç‚¹ä¸ºåŒæ­¥ç±»å‹çš„ã€‚</span><br><span class="line">36:                     HAConnection.this.haService.notifyTransferSome(HAConnection.this.slaveAckOffset);</span><br><span class="line">37:                 &#125;</span><br><span class="line">38:             &#125; else if (readSize == 0) &#123;</span><br><span class="line">39:                 if (++readSizeZeroTimes &gt;= 3) &#123;</span><br><span class="line">40:                     break;</span><br><span class="line">41:                 &#125;</span><br><span class="line">42:             &#125; else &#123;</span><br><span class="line">43:                 log.error(&quot;read socket[&quot; + HAConnection.this.clientAddr + &quot;] &lt; 0&quot;);</span><br><span class="line">44:                 return false;</span><br><span class="line">45:             &#125;</span><br><span class="line">46:         &#125; catch (IOException e) &#123;</span><br><span class="line">47:             log.error(&quot;processReadEvent exception&quot;, e);</span><br><span class="line">48:             return false;</span><br><span class="line">49:         &#125;</span><br><span class="line">50:     &#125;</span><br><span class="line">51: </span><br><span class="line">52:     return true;</span><br><span class="line">53: &#125;</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li><strong>WriteSocketService è®¡ç®— Slaveå¼€å§‹åŒæ­¥çš„ä½ç½®åï¼Œä¸æ–­å‘ Slave ä¼ è¾“æ–°çš„ CommitLogæ•°æ®ã€‚</strong></li>
</ul>
<p><img src="http://static.iocoder.cn/images/RocketMQ/2017_05_14/01.png" alt="HA.WriteSocketServiceæµç¨‹å›¾"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€WriteSocketService.javaã€‘</span><br><span class="line">  2: @Override</span><br><span class="line">  3: public void run() &#123;</span><br><span class="line">  4:     HAConnection.log.info(this.getServiceName() + &quot; service started&quot;);</span><br><span class="line">  5: </span><br><span class="line">  6:     while (!this.isStopped()) &#123;</span><br><span class="line">  7:         try &#123;</span><br><span class="line">  8:             this.selector.select(1000);</span><br><span class="line">  9: </span><br><span class="line"> 10:             // æœªè·å¾—Slaveè¯»å–è¿›åº¦è¯·æ±‚ï¼Œsleepç­‰å¾…ã€‚</span><br><span class="line"> 11:             if (-1 == HAConnection.this.slaveRequestOffset) &#123;</span><br><span class="line"> 12:                 Thread.sleep(10);</span><br><span class="line"> 13:                 continue;</span><br><span class="line"> 14:             &#125;</span><br><span class="line"> 15: </span><br><span class="line"> 16:             // è®¡ç®—åˆå§‹åŒ–nextTransferFromWhere</span><br><span class="line"> 17:             if (-1 == this.nextTransferFromWhere) &#123;</span><br><span class="line"> 18:                 if (0 == HAConnection.this.slaveRequestOffset) &#123;</span><br><span class="line"> 19:                     long masterOffset = HAConnection.this.haService.getDefaultMessageStore().getCommitLog().getMaxOffset();</span><br><span class="line"> 20:                     masterOffset = masterOffset - (masterOffset % HAConnection.this.haService.getDefaultMessageStore().getMessageStoreConfig().getMapedFileSizeCommitLog());</span><br><span class="line"> 21:                     if (masterOffset &lt; 0) &#123;</span><br><span class="line"> 22:                         masterOffset = 0;</span><br><span class="line"> 23:                     &#125;</span><br><span class="line"> 24: </span><br><span class="line"> 25:                     this.nextTransferFromWhere = masterOffset;</span><br><span class="line"> 26:                 &#125; else &#123;</span><br><span class="line"> 27:                     this.nextTransferFromWhere = HAConnection.this.slaveRequestOffset;</span><br><span class="line"> 28:                 &#125;</span><br><span class="line"> 29: </span><br><span class="line"> 30:                 log.info(&quot;master transfer data from &quot; + this.nextTransferFromWhere + &quot; to slave[&quot; + HAConnection.this.clientAddr</span><br><span class="line"> 31:                     + &quot;], and slave request &quot; + HAConnection.this.slaveRequestOffset);</span><br><span class="line"> 32:             &#125;</span><br><span class="line"> 33: </span><br><span class="line"> 34:             if (this.lastWriteOver) &#123;</span><br><span class="line"> 35:                 long interval = HAConnection.this.haService.getDefaultMessageStore().getSystemClock().now() - this.lastWriteTimestamp;</span><br><span class="line"> 36:                 if (interval &gt; HAConnection.this.haService.getDefaultMessageStore().getMessageStoreConfig().getHaSendHeartbeatInterval()) &#123; // å¿ƒè·³</span><br><span class="line"> 37: </span><br><span class="line"> 38:                     // Build Header</span><br><span class="line"> 39:                     this.byteBufferHeader.position(0);</span><br><span class="line"> 40:                     this.byteBufferHeader.limit(headerSize);</span><br><span class="line"> 41:                     this.byteBufferHeader.putLong(this.nextTransferFromWhere);</span><br><span class="line"> 42:                     this.byteBufferHeader.putInt(0);</span><br><span class="line"> 43:                     this.byteBufferHeader.flip();</span><br><span class="line"> 44: </span><br><span class="line"> 45:                     this.lastWriteOver = this.transferData();</span><br><span class="line"> 46:                     if (!this.lastWriteOver)</span><br><span class="line"> 47:                         continue;</span><br><span class="line"> 48:                 &#125;</span><br><span class="line"> 49:             &#125; else &#123; // æœªä¼ è¾“å®Œæˆï¼Œç»§ç»­ä¼ è¾“</span><br><span class="line"> 50:                 this.lastWriteOver = this.transferData();</span><br><span class="line"> 51:                 if (!this.lastWriteOver)</span><br><span class="line"> 52:                     continue;</span><br><span class="line"> 53:             &#125;</span><br><span class="line"> 54: </span><br><span class="line"> 55:             // é€‰æ‹©æ–°çš„CommitLogæ•°æ®è¿›è¡Œä¼ è¾“</span><br><span class="line"> 56:             SelectMappedBufferResult selectResult =</span><br><span class="line"> 57:                 HAConnection.this.haService.getDefaultMessageStore().getCommitLogData(this.nextTransferFromWhere);</span><br><span class="line"> 58:             if (selectResult != null) &#123;</span><br><span class="line"> 59:                 int size = selectResult.getSize();</span><br><span class="line"> 60:                 if (size &gt; HAConnection.this.haService.getDefaultMessageStore().getMessageStoreConfig().getHaTransferBatchSize()) &#123;</span><br><span class="line"> 61:                     size = HAConnection.this.haService.getDefaultMessageStore().getMessageStoreConfig().getHaTransferBatchSize();</span><br><span class="line"> 62:                 &#125;</span><br><span class="line"> 63: </span><br><span class="line"> 64:                 long thisOffset = this.nextTransferFromWhere;</span><br><span class="line"> 65:                 this.nextTransferFromWhere += size;</span><br><span class="line"> 66: </span><br><span class="line"> 67:                 selectResult.getByteBuffer().limit(size);</span><br><span class="line"> 68:                 this.selectMappedBufferResult = selectResult;</span><br><span class="line"> 69: </span><br><span class="line"> 70:                 // Build Header</span><br><span class="line"> 71:                 this.byteBufferHeader.position(0);</span><br><span class="line"> 72:                 this.byteBufferHeader.limit(headerSize);</span><br><span class="line"> 73:                 this.byteBufferHeader.putLong(thisOffset);</span><br><span class="line"> 74:                 this.byteBufferHeader.putInt(size);</span><br><span class="line"> 75:                 this.byteBufferHeader.flip();</span><br><span class="line"> 76: </span><br><span class="line"> 77:                 this.lastWriteOver = this.transferData();</span><br><span class="line"> 78:             &#125; else &#123; // æ²¡æ–°çš„æ¶ˆæ¯ï¼ŒæŒ‚èµ·ç­‰å¾…</span><br><span class="line"> 79:                 HAConnection.this.haService.getWaitNotifyObject().allWaitForRunning(100);</span><br><span class="line"> 80:             &#125;</span><br><span class="line"> 81:         &#125; catch (Exception e) &#123;</span><br><span class="line"> 82: </span><br><span class="line"> 83:             HAConnection.log.error(this.getServiceName() + &quot; service has exception.&quot;, e);</span><br><span class="line"> 84:             break;</span><br><span class="line"> 85:         &#125;</span><br><span class="line"> 86:     &#125;</span><br><span class="line"> 87: </span><br><span class="line"> 88:     // æ–­å¼€è¿æ¥ &amp; æš‚åœå†™çº¿ç¨‹ &amp; æš‚åœè¯»çº¿ç¨‹ &amp; é‡Šæ”¾CommitLog</span><br><span class="line"> 89:     if (this.selectMappedBufferResult != null) &#123;</span><br><span class="line"> 90:         this.selectMappedBufferResult.release();</span><br><span class="line"> 91:     &#125;</span><br><span class="line"> 92: </span><br><span class="line"> 93:     this.makeStop();</span><br><span class="line"> 94: </span><br><span class="line"> 95:     readSocketService.makeStop();</span><br><span class="line"> 96: </span><br><span class="line"> 97:     haService.removeConnection(HAConnection.this);</span><br><span class="line"> 98: </span><br><span class="line"> 99:     SelectionKey sk = this.socketChannel.keyFor(this.selector);</span><br><span class="line">100:     if (sk != null) &#123;</span><br><span class="line">101:         sk.cancel();</span><br><span class="line">102:     &#125;</span><br><span class="line">103: </span><br><span class="line">104:     try &#123;</span><br><span class="line">105:         this.selector.close();</span><br><span class="line">106:         this.socketChannel.close();</span><br><span class="line">107:     &#125; catch (IOException e) &#123;</span><br><span class="line">108:         HAConnection.log.error(&quot;&quot;, e);</span><br><span class="line">109:     &#125;</span><br><span class="line">110: </span><br><span class="line">111:     HAConnection.log.info(this.getServiceName() + &quot; service end&quot;);</span><br><span class="line">112: &#125;</span><br><span class="line">113: </span><br><span class="line">114: /**</span><br><span class="line">115:  * ä¼ è¾“æ•°æ®</span><br><span class="line">116:  */</span><br><span class="line">117: private boolean transferData() throws Exception &#123;</span><br><span class="line">118:     int writeSizeZeroTimes = 0;</span><br><span class="line">119:     // Write Header</span><br><span class="line">120:     while (this.byteBufferHeader.hasRemaining()) &#123;</span><br><span class="line">121:         int writeSize = this.socketChannel.write(this.byteBufferHeader);</span><br><span class="line">122:         if (writeSize &gt; 0) &#123;</span><br><span class="line">123:             writeSizeZeroTimes = 0;</span><br><span class="line">124:             this.lastWriteTimestamp = HAConnection.this.haService.getDefaultMessageStore().getSystemClock().now();</span><br><span class="line">125:         &#125; else if (writeSize == 0) &#123;</span><br><span class="line">126:             if (++writeSizeZeroTimes &gt;= 3) &#123;</span><br><span class="line">127:                 break;</span><br><span class="line">128:             &#125;</span><br><span class="line">129:         &#125; else &#123;</span><br><span class="line">130:             throw new Exception(&quot;ha master write header error &lt; 0&quot;);</span><br><span class="line">131:         &#125;</span><br><span class="line">132:     &#125;</span><br><span class="line">133: </span><br><span class="line">134:     if (null == this.selectMappedBufferResult) &#123;</span><br><span class="line">135:         return !this.byteBufferHeader.hasRemaining();</span><br><span class="line">136:     &#125;</span><br><span class="line">137: </span><br><span class="line">138:     writeSizeZeroTimes = 0;</span><br><span class="line">139: </span><br><span class="line">140:     // Write Body</span><br><span class="line">141:     if (!this.byteBufferHeader.hasRemaining()) &#123;</span><br><span class="line">142:         while (this.selectMappedBufferResult.getByteBuffer().hasRemaining()) &#123;</span><br><span class="line">143:             int writeSize = this.socketChannel.write(this.selectMappedBufferResult.getByteBuffer());</span><br><span class="line">144:             if (writeSize &gt; 0) &#123;</span><br><span class="line">145:                 writeSizeZeroTimes = 0;</span><br><span class="line">146:                 this.lastWriteTimestamp = HAConnection.this.haService.getDefaultMessageStore().getSystemClock().now();</span><br><span class="line">147:             &#125; else if (writeSize == 0) &#123;</span><br><span class="line">148:                 if (++writeSizeZeroTimes &gt;= 3) &#123;</span><br><span class="line">149:                     break;</span><br><span class="line">150:                 &#125;</span><br><span class="line">151:             &#125; else &#123;</span><br><span class="line">152:                 throw new Exception(&quot;ha master write body error &lt; 0&quot;);</span><br><span class="line">153:             &#125;</span><br><span class="line">154:         &#125;</span><br><span class="line">155:     &#125;</span><br><span class="line">156: </span><br><span class="line">157:     boolean result = !this.byteBufferHeader.hasRemaining() &amp;&amp; !this.selectMappedBufferResult.getByteBuffer().hasRemaining();</span><br><span class="line">158: </span><br><span class="line">159:     if (!this.selectMappedBufferResult.getByteBuffer().hasRemaining()) &#123;</span><br><span class="line">160:         this.selectMappedBufferResult.release();</span><br><span class="line">161:         this.selectMappedBufferResult = null;</span><br><span class="line">162:     &#125;</span><br><span class="line">163: </span><br><span class="line">164:     return result;</span><br><span class="line">165: &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-6-Master-SYNC"><a href="#3-1-6-Master-SYNC" class="headerlink" title="3.1.6 Master_SYNC"></a>3.1.6 Master_SYNC</h3><ul>
<li><strong>Producer å‘é€æ¶ˆæ¯æ—¶ï¼ŒMaster_SYNCèŠ‚ç‚¹ ä¼šç­‰å¾… SlaveèŠ‚ç‚¹ å­˜å‚¨å®Œæ¯•åå†è¿”å›å‘é€ç»“æœã€‚</strong></li>
</ul>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> 1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€CommitLog.javaã€‘</span><br><span class="line"> 2: public PutMessageResult putMessage(final MessageExtBrokerInner msg) &#123;</span><br><span class="line"> 3:     // ....çœç•¥å¤„ç†å‘é€ä»£ç  </span><br><span class="line"> 4:     // Synchronous write double å¦‚æœæ˜¯åŒæ­¥Masterï¼ŒåŒæ­¥åˆ°ä»èŠ‚ç‚¹</span><br><span class="line"> 5:     if (BrokerRole.SYNC_MASTER == this.defaultMessageStore.getMessageStoreConfig().getBrokerRole()) &#123;</span><br><span class="line"> 6:         HAService service = this.defaultMessageStore.getHaService();</span><br><span class="line"> 7:         if (msg.isWaitStoreMsgOK()) &#123;</span><br><span class="line"> 8:             // Determine whether to wait</span><br><span class="line"> 9:             if (service.isSlaveOK(result.getWroteOffset() + result.getWroteBytes())) &#123;</span><br><span class="line">10:                 if (null == request) &#123;</span><br><span class="line">11:                     request = new GroupCommitRequest(result.getWroteOffset() + result.getWroteBytes());</span><br><span class="line">12:                 &#125;</span><br><span class="line">13:                 service.putRequest(request);</span><br><span class="line">14: </span><br><span class="line">15:                 // å”¤é†’WriteSocketService</span><br><span class="line">16:                 service.getWaitNotifyObject().wakeupAll();</span><br><span class="line">17: </span><br><span class="line">18:                 boolean flushOK = request.waitForFlush(this.defaultMessageStore.getMessageStoreConfig().getSyncFlushTimeout());</span><br><span class="line">19:                 if (!flushOK) &#123;</span><br><span class="line">20:                     log.error(&quot;do sync transfer other node, wait return, but failed, topic: &quot; + msg.getTopic() + &quot; tags: &quot;</span><br><span class="line">21:                         + msg.getTags() + &quot; client address: &quot; + msg.getBornHostString());</span><br><span class="line">22:                     putMessageResult.setPutMessageStatus(PutMessageStatus.FLUSH_SLAVE_TIMEOUT);</span><br><span class="line">23:                 &#125;</span><br><span class="line">24:             &#125;</span><br><span class="line">25:             // Slave problem</span><br><span class="line">26:             else &#123;</span><br><span class="line">27:                 // Tell the producer, slave not available</span><br><span class="line">28:                 putMessageResult.setPutMessageStatus(PutMessageStatus.SLAVE_NOT_AVAILABLE);</span><br><span class="line">29:             &#125;</span><br><span class="line">30:         &#125;</span><br><span class="line">31:     &#125;</span><br><span class="line">32: </span><br><span class="line">33:     return putMessageResult;</span><br><span class="line">34: &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ç¬¬ 16 è¡Œ ï¼šå”¤é†’</li>
</ul>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WriteSocketService</span><br></pre></td></tr></table></figure>

<p>  ã€‚</p>
<ul>
<li>å”¤é†’åï¼Œ<code>WriteSocketService</code> æŒ‚èµ·ç­‰å¾…æ–°æ¶ˆæ¯ç»“æŸï¼Œ<code>Master</code> ä¼ è¾“ <code>Slave</code> æ–°çš„ <code>CommitLog</code> æ•°æ®ã€‚</li>
<li><code>Slave</code> æ”¶åˆ°æ•°æ®åï¼Œ<strong>ç«‹å³</strong>ä¸ŠæŠ¥æœ€æ–°çš„ <code>CommitLog</code> åŒæ­¥è¿›åº¦åˆ° <code>Master</code>ã€‚<code>ReadSocketService</code> å”¤é†’<strong>ç¬¬ 18 è¡Œ</strong>ï¼š<code>request#waitForFlush(...)</code>ã€‚</li>
</ul>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ <code>GroupTransferService</code> çš„æ ¸å¿ƒé€»è¾‘ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> 1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€GroupTransferService.javaã€‘</span><br><span class="line"> 2: private void doWaitTransfer() &#123;</span><br><span class="line"> 3:     synchronized (this.requestsRead) &#123;</span><br><span class="line"> 4:         if (!this.requestsRead.isEmpty()) &#123;</span><br><span class="line"> 5:             for (CommitLog.GroupCommitRequest req : this.requestsRead) &#123;</span><br><span class="line"> 6:                 // ç­‰å¾…Slaveä¸Šä¼ è¿›åº¦</span><br><span class="line"> 7:                 boolean transferOK = HAService.this.push2SlaveMaxOffset.get() &gt;= req.getNextOffset();</span><br><span class="line"> 8:                 for (int i = 0; !transferOK &amp;&amp; i &lt; 5; i++) &#123;</span><br><span class="line"> 9:                     this.notifyTransferObject.waitForRunning(1000); // å”¤é†’</span><br><span class="line">10:                     transferOK = HAService.this.push2SlaveMaxOffset.get() &gt;= req.getNextOffset();</span><br><span class="line">11:                 &#125;</span><br><span class="line">12: </span><br><span class="line">13:                 if (!transferOK) &#123;</span><br><span class="line">14:                     log.warn(&quot;transfer messsage to slave timeout, &quot; + req.getNextOffset());</span><br><span class="line">15:                 &#125;</span><br><span class="line">16: </span><br><span class="line">17:                 // å”¤é†’è¯·æ±‚ï¼Œå¹¶è®¾ç½®æ˜¯å¦SlaveåŒæ­¥æˆåŠŸ</span><br><span class="line">18:                 req.wakeupCustomer(transferOK);</span><br><span class="line">19:             &#125;</span><br><span class="line">20: </span><br><span class="line">21:             this.requestsRead.clear();</span><br><span class="line">22:         &#125;</span><br><span class="line">23:     &#125;</span><br><span class="line">24: &#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-2-Producer-å‘é€æ¶ˆæ¯"><a href="#3-2-Producer-å‘é€æ¶ˆæ¯" class="headerlink" title="3.2 Producer å‘é€æ¶ˆæ¯"></a>3.2 Producer å‘é€æ¶ˆæ¯</h2><ul>
<li><strong>Producer å‘é€æ¶ˆæ¯æ—¶ï¼Œä¼šå¯¹ Brokeré›†ç¾¤ çš„æ‰€æœ‰é˜Ÿåˆ—è¿›è¡Œé€‰æ‹©ã€‚</strong></li>
</ul>
<p>æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"> 1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€DefaultMQProducerImpl.javaã€‘</span><br><span class="line"> 2: private SendResult sendDefaultImpl(//</span><br><span class="line"> 3:     Message msg, //</span><br><span class="line"> 4:     final CommunicationMode communicationMode, //</span><br><span class="line"> 5:     final SendCallback sendCallback, //</span><br><span class="line"> 6:     final long timeout//</span><br><span class="line"> 7: ) throws MQClientException, RemotingException, MQBrokerException, InterruptedException &#123;</span><br><span class="line"> 8:     // .... çœç•¥ï¼šå¤„ç†ã€æ ¡éªŒé€»è¾‘ã€‘</span><br><span class="line"> 9:     // è·å– Topicè·¯ç”±ä¿¡æ¯</span><br><span class="line">10:     TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic());</span><br><span class="line">11:     if (topicPublishInfo != null &amp;&amp; topicPublishInfo.ok()) &#123;</span><br><span class="line">12:         MessageQueue mq = null; // æœ€åé€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—</span><br><span class="line">13:         Exception exception = null;</span><br><span class="line">14:         SendResult sendResult = null; // æœ€åä¸€æ¬¡å‘é€ç»“æœ</span><br><span class="line">15:         int timesTotal = communicationMode == CommunicationMode.SYNC ? 1 + this.defaultMQProducer.getRetryTimesWhenSendFailed() : 1; // åŒæ­¥å¤šæ¬¡è°ƒç”¨</span><br><span class="line">16:         int times = 0; // ç¬¬å‡ æ¬¡å‘é€</span><br><span class="line">17:         String[] brokersSent = new String[timesTotal]; // å­˜å‚¨æ¯æ¬¡å‘é€æ¶ˆæ¯é€‰æ‹©çš„brokerå</span><br><span class="line">18:         // å¾ªç¯è°ƒç”¨å‘é€æ¶ˆæ¯ï¼Œç›´åˆ°æˆåŠŸ</span><br><span class="line">19:         for (; times &lt; timesTotal; times++) &#123;</span><br><span class="line">20:             String lastBrokerName = null == mq ? null : mq.getBrokerName();</span><br><span class="line">21:             MessageQueue tmpmq = this.selectOneMessageQueue(topicPublishInfo, lastBrokerName); // é€‰æ‹©æ¶ˆæ¯è¦å‘é€åˆ°çš„é˜Ÿåˆ—</span><br><span class="line">22:             if (tmpmq != null) &#123;</span><br><span class="line">23:                 mq = tmpmq;</span><br><span class="line">24:                 brokersSent[times] = mq.getBrokerName();</span><br><span class="line">25:                 try &#123;</span><br><span class="line">26:                     beginTimestampPrev = System.currentTimeMillis();</span><br><span class="line">27:                     // è°ƒç”¨å‘é€æ¶ˆæ¯æ ¸å¿ƒæ–¹æ³•</span><br><span class="line">28:                     sendResult = this.sendKernelImpl(msg, mq, communicationMode, sendCallback, topicPublishInfo, timeout);</span><br><span class="line">29:                     endTimestamp = System.currentTimeMillis();</span><br><span class="line">30:                     // æ›´æ–°Brokerå¯ç”¨æ€§ä¿¡æ¯</span><br><span class="line">31:                     this.updateFaultItem(mq.getBrokerName(), endTimestamp - beginTimestampPrev, false);</span><br><span class="line">32:                     // .... çœç•¥ï¼šå¤„ç†ã€å‘é€è¿”å›ç»“æœã€‘</span><br><span class="line">33:                     &#125;</span><br><span class="line">34:                 &#125; catch (e) &#123; // .... çœç•¥ï¼šå¤„ç†ã€å¼‚å¸¸ã€‘</span><br><span class="line">35:                     </span><br><span class="line">36:                 &#125;</span><br><span class="line">37:             &#125; else &#123;</span><br><span class="line">38:                 break;</span><br><span class="line">39:             &#125;</span><br><span class="line">40:         &#125;</span><br><span class="line">41:         // .... çœç•¥ï¼šå¤„ç†ã€å‘é€è¿”å›ç»“æœã€‘</span><br><span class="line">42:     &#125;</span><br><span class="line">43:     // .... çœç•¥ï¼šå¤„ç†ã€æ‰¾ä¸åˆ°æ¶ˆæ¯è·¯ç”±ã€‘</span><br><span class="line">44: &#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸‹æ˜¯è°ƒè¯• <code>#sendDefaultImpl(...)</code> æ—¶ <code>TopicPublishInfo</code> çš„ç»“æœï¼Œ<code>Producer</code> è·å¾—åˆ°äº† <code>broker-a</code>,<code>broker-b</code> ä¸¤ä¸ª <code>Broker</code>åˆ†ç»„ çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼š<br><img src="http://static.iocoder.cn/images/RocketMQ/2017_05_14/05.png" alt="Producer.TopicPublishInfo.è°ƒè¯•.png"></p>
<h2 id="3-3-Consumer-æ¶ˆè´¹æ¶ˆæ¯"><a href="#3-3-Consumer-æ¶ˆè´¹æ¶ˆæ¯" class="headerlink" title="3.3 Consumer æ¶ˆè´¹æ¶ˆæ¯"></a>3.3 Consumer æ¶ˆè´¹æ¶ˆæ¯</h2><ul>
<li><strong>Consumer æ¶ˆè´¹æ¶ˆæ¯æ—¶ï¼Œä¼šå¯¹ Brokeré›†ç¾¤ çš„æ‰€æœ‰é˜Ÿåˆ—è¿›è¡Œé€‰æ‹©ã€‚</strong></li>
</ul>
<h1 id="4-æ€»ç»“"><a href="#4-æ€»ç»“" class="headerlink" title="4. æ€»ç»“"></a>4. æ€»ç»“</h1><p><img src="http://static.iocoder.cn/images/RocketMQ/2017_05_14/03.jpeg" alt="HAæ€»ç»“.jpeg"></p>
<p><a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">https://hexo.io/docs/deployment.html</a>)</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Ke Dan">
            
              <p class="site-author-name" itemprop="name">Ke Dan</p>
              <p class="site-description motion-element" itemprop="description">ç”Ÿæ´»ä¸æ­¢çœ¼å‰çš„è‹Ÿä¸”ï¼Œè¿˜æœ‰è¯—ä¸è¿œæ–¹</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">1</span>
                  <span class="site-state-item-name">æ—¥å¿—</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-æ¦‚è¿°"><span class="nav-number">1.</span> <span class="nav-text">1. æ¦‚è¿°</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-Namesrv-é«˜å¯ç”¨"><span class="nav-number">2.</span> <span class="nav-text">2. Namesrv é«˜å¯ç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-Broker-æ³¨å†Œåˆ°-Namesrv"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 Broker æ³¨å†Œåˆ° Namesrv</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-Producerã€Consumer-è®¿é—®-Namesrv"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 Producerã€Consumer è®¿é—® Namesrv</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-Broker-é«˜å¯ç”¨"><span class="nav-number">3.</span> <span class="nav-text">3. Broker é«˜å¯ç”¨</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-Broker-ä¸»ä»"><span class="nav-number">3.1.</span> <span class="nav-text">3.2 Broker ä¸»ä»</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-é…ç½®"><span class="nav-number">3.1.1.</span> <span class="nav-text">3.1.1 é…ç½®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-ç»„ä»¶"><span class="nav-number">3.1.2.</span> <span class="nav-text">3.1.2 ç»„ä»¶</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-3-é€šä¿¡åè®®"><span class="nav-number">3.1.3.</span> <span class="nav-text">3.1.3 é€šä¿¡åè®®</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-4-Slave"><span class="nav-number">3.1.4.</span> <span class="nav-text">3.1.4 Slave</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-5-Master"><span class="nav-number">3.1.5.</span> <span class="nav-text">3.1.5 Master</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-6-Master-SYNC"><span class="nav-number">3.1.6.</span> <span class="nav-text">3.1.6 Master_SYNC</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-Producer-å‘é€æ¶ˆæ¯"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 Producer å‘é€æ¶ˆæ¯</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-Consumer-æ¶ˆè´¹æ¶ˆæ¯"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 Consumer æ¶ˆè´¹æ¶ˆæ¯</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-æ€»ç»“"><span class="nav-number">4.</span> <span class="nav-text">4. æ€»ç»“</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ke Dan</span>

  
</div>


  <div class="powered-by">ç”± <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
